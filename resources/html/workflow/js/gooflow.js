function GooFlow(t,e){this.$id=t.attr("id");this.$bgDiv=t;this.$bgDiv.addClass("GooFlow");var i=(e.width||800)-2;var a=(e.height||500)-2;this.$bgDiv.css({width:i+"px",height:a+"px"});this.$tool=null;this.$head=null;this.$title="newFlow_1";this.$defaultTitleId="2";this.$nodeRemark={};this.$nowType="cursor";this.$lineData={};this.$lineCount=0;this.$nodeData={};this.$nodeCount=0;this.$areaData={};this.$areaCount=0;this.$lineDom={};this.$nodeDom={};this.$areaDom={};this.$max=e.initNum||1;this.$focus="";this.$cursor="default";this.$editable=false;this.$deletedItem={};var o=0;var s="";if(e.haveHead){s="<div class='GooFlow_head'><label title='"+(e.initLabelText||"newFlow_1")+"'>"+(e.initLabelText||"newFlow_1")+"</label>";for(var r=0;r<e.headBtns.length;++r){s+="<a href='javascript:void(0)' class='GooFlow_head_btn'><b class='ico_"+e.headBtns[r]+"'></b></a>"}s+="</div>";this.$head=$(s);this.$bgDiv.append(this.$head);o=24;this.onBtnNewClick=function(){var t=this;var e=prompt(ch("�����µ����ƣ�"),"newFlow_"+this.$defaultTitleId++);if(e!=null){this.clearData();this.setTitle(e)}};this.onBtnOpenClick=function(){var t=this};this.onBtnSaveClick=function(){var t=this};this.onFreshClick=function(){var t=this};if(e.headBtns)this.$head.on("click",{inthis:this},function(t){if(!t)t=window.event;var e=t.target;if(e.tagName=="DIV"||e.tagName=="SPAN")return;else if(e.tagName=="a")e=e.childNode[0];var i=t.data.inthis;switch($(e).attr("class")){case"ico_new":if(i.onBtnNewClick!=null)i.onBtnNewClick();break;case"ico_open":if(i.onBtnOpenClick!=null)i.onBtnOpenClick();break;case"ico_save":if(i.onBtnSaveClick!=null)i.onBtnSaveClick();break;case"ico_undo":i.undo();break;case"ico_redo":i.redo();break;case"ico_reload":if(i.onFreshClick!=null)i.onFreshClick();break}})}var n=0;if(e.haveTool){this.$bgDiv.append("<div class='GooFlow_tool'"+(e.haveHead?"":" style='margin-top:3px'")+"><div style='height:"+(a-o-(e.haveHead?7:10))+"px' class='GooFlow_tool_div'></div></div>");this.$tool=this.$bgDiv.find(".GooFlow_tool div");this.$tool.append("<a href='javascript:void(0)' type='cursor' class='GooFlow_tool_btndown' id='"+this.$id+"_btn_cursor'><b class='ico_cursor'/></a><a href='javascript:void(0)' type='direct' class='GooFlow_tool_btn' id='"+this.$id+"_btn_direct'><b class='ico_direct'/></a>");if(e.toolBtns&&e.toolBtns.length>0){s="<span/>";for(var l=0;l<e.toolBtns.length;++l){s+="<a href='javascript:void(0)' type='"+e.toolBtns[l]+"' id='"+this.$id+"_btn_"+e.toolBtns[l].split(" ")[0]+"' class='GooFlow_tool_btn'><b class='ico_"+e.toolBtns[l]+"'/></a>"}this.$tool.append(s)}if(e.haveGroup)this.$tool.append("<span/><a href='javascript:void(0)' type='group' class='GooFlow_tool_btn' id='"+this.$id+"_btn_group'><b class='ico_group'/></a>");n=31;this.$nowType="cursor";this.$tool.on("click",{inthis:this},function(t){if(!t)t=window.event;var e;switch(t.target.tagName){case"SPAN":return false;case"DIV":return false;case"B":e=t.target.parentNode;break;case"A":e=t.target}var i=$(e).attr("type");t.data.inthis.switchToolBtn(i);return false});this.$editable=true}i=i-n-8;a=a-o-(e.haveHead?5:8);this.$bgDiv.append("<div class='GooFlow_work' style='width:"+i+"px;height:"+a+"px;"+(e.haveHead?"":"margin-top:3px")+"'></div>");this.$workArea=$("<div class='GooFlow_work_inner' style='width:"+i*3+"px;height:"+a*3+"px'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"});this.$bgDiv.children(".GooFlow_work").append(this.$workArea);this.$draw=null;this.initDraw("draw_"+this.$id,i,a);this.$group=null;if(e.haveGroup)this.initGroup(i,a);if(this.$editable){this.$workArea.on("click",{inthis:this},function(t){if(!t)t=window.event;if(!t.data.inthis.$editable)return;var e=t.data.inthis.$nowType;if(e=="cursor"){var i=$(t.target);var a=i.prop("tagName");if(a=="svg"||a=="DIV"&&i.prop("class").indexOf("GooFlow_work")>-1||a=="LABEL")t.data.inthis.blurItem();return}else if(e=="direct"||e=="group")return;var o,s;var r=mousePosition(t),i=getElCoordinate(this);o=r.x-i.left+this.parentNode.scrollLeft-1;s=r.y-i.top+this.parentNode.scrollTop-1;t.data.inthis.addNode(t.data.inthis.$id+"_node_"+t.data.inthis.$max,{name:"node_"+t.data.inthis.$max,left:o,top:s,type:t.data.inthis.$nowType});t.data.inthis.$max++});this.$workArea.mousemove({inthis:this},function(t){if(t.data.inthis.$nowType!="direct")return;var e=$(this).data("lineStart");if(!e)return;var i=mousePosition(t),a=getElCoordinate(this);var o,s;o=i.x-a.left+this.parentNode.scrollLeft;s=i.y-a.top+this.parentNode.scrollTop;var r=document.getElementById("GooFlow_tmp_line");r.childNodes[0].setAttribute("d","M "+e.x+" "+e.y+" L "+o+" "+s);r.childNodes[1].setAttribute("d","M "+e.x+" "+e.y+" L "+o+" "+s);if(r.childNodes[1].getAttribute("marker-end")=='url("#arrow2")')r.childNodes[1].setAttribute("marker-end","url(#arrow3)");else r.childNodes[1].setAttribute("marker-end","url(#arrow2)")});this.$workArea.mouseup({inthis:this},function(t){if(t.data.inthis.$nowType!="direct")return;$(this).css("cursor","auto").removeData("lineStart");var e=document.getElementById("GooFlow_tmp_line");if(e)t.data.inthis.$draw.removeChild(e)});this.initWorkForNode();this.$ghost=$("<div class='rs_ghost GooFlow_item item_round'></div>").attr({unselectable:"on",onselectstart:"return false",onselect:"document.selection.empty()"});this.$bgDiv.append(this.$ghost);this.$textArea=$("<textarea></textarea>");this.$bgDiv.append(this.$textArea);this.$lineMove=$("<div class='GooFlow_line_move' style='display:none'></div>");this.$workArea.append(this.$lineMove);this.$lineMove.on("mousedown",{inthis:this},function(t){if(t.button==2)return false;var e=$(this);e.css({"background-color":"#333"});var a=t.data.inthis;var i=mousePosition(t),o=getElCoordinate(a.$workArea[0]);var s,r;s=i.x-o.left+a.$workArea[0].parentNode.scrollLeft;r=i.y-o.top+a.$workArea[0].parentNode.scrollTop;var n=a.$lineMove.position();var l=s-n.left,h=r-n.top;var d=false;document.onmousemove=function(t){if(!t)t=window.event;var e=mousePosition(t);var i=a.$lineMove.position();s=e.x-o.left+a.$workArea[0].parentNode.scrollLeft;r=e.y-o.top+a.$workArea[0].parentNode.scrollTop;if(a.$lineMove.data("type")=="lr"){s=s-l;if(s<0)s=0;else if(s>a.$workArea.width())s=a.$workArea.width();a.$lineMove.css({left:s+"px"})}else if(a.$lineMove.data("type")=="tb"){r=r-h;if(r<0)r=0;else if(r>a.$workArea.height())r=a.$workArea.height();a.$lineMove.css({top:r+"px"})}d=true};document.onmouseup=function(t){if(d){var e=a.$lineMove.position();if(a.$lineMove.data("type")=="lr")a.setLineM(a.$lineMove.data("tid"),e.left+3);else if(a.$lineMove.data("type")=="tb")a.setLineM(a.$lineMove.data("tid"),e.top+3)}a.$lineMove.css({"background-color":"transparent"});if(a.$focus==a.$lineMove.data("tid")){a.focusItem(a.$lineMove.data("tid"))}document.onmousemove=null;document.onmouseup=null}});this.$lineOper=$("<div class='GooFlow_line_oper' style='display:none'><b class='b_l1'></b><b class='b_l2'></b><b class='b_l3'></b><b class='b_x'></b></div>");this.$workArea.append(this.$lineOper);this.$lineOper.on("click",{inthis:this},function(t){if(!t)t=window.event;if(t.target.tagName!="B")return;var e=t.data.inthis;var i=$(this).data("tid");switch($(t.target).attr("class")){case"b_x":e.delLine(i);this.style.display="none";break;case"b_l1":e.setLineType(i,"lr");break;case"b_l2":e.setLineType(i,"tb");break;case"b_l3":e.setLineType(i,"sl");break}});this.onItemAdd=null;this.onItemDel=null;this.onItemMove=null;this.onItemRename=null;this.onItemFocus=null;this.onItemBlur=null;this.onItemResize=null;this.onLineMove=null;this.onLineSetType=null;this.onItemMark=null;if(e.useOperStack&&this.$editable){this.$undoStack=[];this.$redoStack=[];this.$isUndo=0;this.pushOper=function(t,e){var i=this.$undoStack.length;if(this.$isUndo==1){this.$redoStack.push([t,e]);this.$isUndo=false;if(this.$redoStack.length>40)this.$redoStack.shift()}else{this.$undoStack.push([t,e]);if(this.$undoStack.length>40)this.$undoStack.shift();if(this.$isUndo==0){this.$redoStack.splice(0,this.$redoStack.length)}this.$isUndo=0}};this.pushExternalOper=function(t,e){this.pushOper("externalFunc",[t,e])};this.undo=function(){if(this.$undoStack.length==0)return;var t=this.$undoStack.pop();this.$isUndo=1;if(t[0]=="externalFunc"){t[1][0](t[1][1])}else{switch(t[1].length){case 0:this[t[0]]();break;case 1:this[t[0]](t[1][0]);break;case 2:this[t[0]](t[1][0],t[1][1]);break;case 3:this[t[0]](t[1][0],t[1][1],t[1][2]);break;case 4:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3]);break;case 5:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4]);break;case 6:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5]);break}}};this.redo=function(){if(this.$redoStack.length==0)return;var t=this.$redoStack.pop();this.$isUndo=2;if(t[0]=="externalFunc"){t[1][0](t[1][1])}else{switch(t[1].length){case 0:this[t[0]]();break;case 1:this[t[0]](t[1][0]);break;case 2:this[t[0]](t[1][0],t[1][1]);break;case 3:this[t[0]](t[1][0],t[1][1],t[1][2]);break;case 4:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3]);break;case 5:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4]);break;case 6:this[t[0]](t[1][0],t[1][1],t[1][2],t[1][3],t[1][4],t[1][5]);break}}}}$(document).keydown({inthis:this},function(t){var e=t.data.inthis;if(e.$focus=="")return;switch(t.keyCode){case 46:e.delNode(e.$focus,true);e.delLine(e.$focus);break}})}}GooFlow.prototype={getSvgMarker:function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg","marker");i.setAttribute("id",t);i.setAttribute("viewBox","0 0 6 6");i.setAttribute("refX",5);i.setAttribute("refY",3);i.setAttribute("markerUnits","strokeWidth");i.setAttribute("markerWidth",6);i.setAttribute("markerHeight",6);i.setAttribute("orient","auto");var a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d","M 0 0 L 6 3 L 0 6 z");a.setAttribute("fill",e);a.setAttribute("stroke-width",0);i.appendChild(a);return i},initDraw:function(t,e,i){var a;this.$draw=document.createElementNS("http://www.w3.org/2000/svg","svg");this.$workArea.prepend(this.$draw);var o=document.createElementNS("http://www.w3.org/2000/svg","defs");this.$draw.appendChild(o);o.appendChild(GooFlow.prototype.getSvgMarker("arrow1","#15428B"));o.appendChild(GooFlow.prototype.getSvgMarker("arrow2","#ff3300"));o.appendChild(GooFlow.prototype.getSvgMarker("arrow3","#ff3300"));this.$draw.id=t;this.$draw.style.width=e*3+"px";this.$draw.style.height=+i*3+"px";var s=null;s="g";if(this.$editable){$(this.$draw).delegate(s,"click",{inthis:this},function(t){t.data.inthis.focusItem(this.id,true)});$(this.$draw).delegate(s,"dblclick",{inthis:this},function(t){var e,i,a,o,s;var r=t.data.inthis;e=this.childNodes[2].textContent;o=this.getAttribute("from").split(",");s=this.getAttribute("to").split(",");if(r.$lineData[this.id].type=="lr"){o[0]=r.$lineData[this.id].M;s[0]=o[0]}else if(r.$lineData[this.id].type=="tb"){o[1]=r.$lineData[this.id].M;s[1]=o[1]}i=(parseInt(o[0],10)+parseInt(s[0],10))/2-60;a=(parseInt(o[1],10)+parseInt(s[1],10))/2-12;var n=getElCoordinate(r.$workArea[0]);r.$textArea.val(e).css({display:"block",width:120,height:14,left:n.left+i-r.$workArea[0].parentNode.scrollLeft,top:n.top+a-r.$workArea[0].parentNode.scrollTop}).data("id",r.$focus).focus();r.$workArea.parent().one("mousedown",function(t){if(t.button==2)return false;r.setName(r.$textArea.data("id"),r.$textArea.val(),"line");r.$textArea.val("").removeData("id").hide()})})}},initGroup:function(t,e){this.$group=$("<div class='GooFlow_work_group' style='width:"+t*3+"px;height:"+e*3+"px'></div>");this.$workArea.prepend(this.$group);if(!this.$editable)return;this.$group.on("mousedown",{inthis:this},function(t){if(t.button==2)return false;var i=t.data.inthis;if(i.$nowType!="group")return;if(i.$textArea.css("display")=="block"){i.setName(i.$textArea.data("id"),i.$textArea.val(),"area");i.$textArea.val("").removeData("id").hide();return false}if(!t)t=window.event;var a=$(t.target).css("cursor");var o=t.target.parentNode;switch(a){case"nw-resize":o=o.parentNode;break;case"w-resize":o=o.parentNode;break;case"n-resize":o=o.parentNode;break;case"move":break;default:return}o=o.id;var s=1;var e=mousePosition(t),r=getElCoordinate(i.$workArea[0]);var n,l;n=e.x-r.left+i.$workArea[0].parentNode.scrollLeft;l=e.y-r.top+i.$workArea[0].parentNode.scrollTop;if(a!="move"){i.$ghost.css({display:"block",width:i.$areaData[o].width-2+"px",height:i.$areaData[o].height-2+"px",top:i.$areaData[o].top+r.top-i.$workArea[0].parentNode.scrollTop+s+"px",left:i.$areaData[o].left+r.left-i.$workArea[0].parentNode.scrollLeft+s+"px",cursor:a});var h=i.$areaData[o].left+i.$areaData[o].width-n;var d=i.$areaData[o].top+i.$areaData[o].height-l}else{var h=n-i.$areaData[o].left;var d=l-i.$areaData[o].top}var f=false;i.$ghost.css("cursor",a);document.onmousemove=function(t){if(!t)t=window.event;var e=mousePosition(t);if(a!="move"){n=e.x-r.left+i.$workArea[0].parentNode.scrollLeft-i.$areaData[o].left+h;l=e.y-r.top+i.$workArea[0].parentNode.scrollTop-i.$areaData[o].top+d;if(n<200)n=200;if(l<100)l=100;switch(a){case"nw-resize":i.$ghost.css({width:n-2+"px",height:l-2+"px"});break;case"w-resize":i.$ghost.css({width:n-2+"px"});break;case"n-resize":i.$ghost.css({height:l-2+"px"});break}}else{if(i.$ghost.css("display")=="none"){i.$ghost.css({display:"block",width:i.$areaData[o].width-2+"px",height:i.$areaData[o].height-2+"px",top:i.$areaData[o].top+r.top-i.$workArea[0].parentNode.scrollTop+s+"px",left:i.$areaData[o].left+r.left-i.$workArea[0].parentNode.scrollLeft+s+"px",cursor:a})}n=e.x-h;l=e.y-d;if(n<r.left-i.$workArea[0].parentNode.scrollLeft)n=r.left-i.$workArea[0].parentNode.scrollLeft;else if(n+i.$workArea[0].parentNode.scrollLeft+i.$areaData[o].width>r.left+i.$workArea.width())n=r.left+i.$workArea.width()-i.$workArea[0].parentNode.scrollLeft-i.$areaData[o].width;if(l<r.top-i.$workArea[0].parentNode.scrollTop)l=r.top-i.$workArea[0].parentNode.scrollTop;else if(l+i.$workArea[0].parentNode.scrollTop+i.$areaData[o].height>r.top+i.$workArea.height())l=r.top+i.$workArea.height()-i.$workArea[0].parentNode.scrollTop-i.$areaData[o].height;i.$ghost.css({left:n+s+"px",top:l+s+"px"})}f=true};document.onmouseup=function(t){i.$ghost.empty().hide();document.onmousemove=null;document.onmouseup=null;if(!f)return;if(a!="move")i.resizeArea(o,i.$ghost.outerWidth(),i.$ghost.outerHeight());else i.moveArea(o,n+i.$workArea[0].parentNode.scrollLeft-r.left,l+i.$workArea[0].parentNode.scrollTop-r.top);return false}});this.$group.on("dblclick",{inthis:this},function(t){var e=t.data.inthis;if(e.$nowType!="group")return;if(!t)t=window.event;if(t.target.tagName!="LABEL")return false;var i=t.target.innerHTML;var a=t.target.parentNode;var o=parseInt(a.style.left,10)+18,s=parseInt(a.style.top,10)+1;var r=getElCoordinate(e.$workArea[0]);e.$textArea.val(i).css({display:"block",width:100,height:14,left:r.left+o-e.$workArea[0].parentNode.scrollLeft,top:r.top+s-e.$workArea[0].parentNode.scrollTop}).data("id",a.id).focus();e.$workArea.parent().one("mousedown",function(t){if(t.button==2)return false;if(e.$textArea.css("display")=="block"){e.setName(e.$textArea.data("id"),e.$textArea.val(),"area");e.$textArea.val("").removeData("id").hide()}});return false});this.$group.mouseup({inthis:this},function(t){var e=t.data.inthis;if(e.$nowType!="group")return;if(!t)t=window.event;switch($(t.target).attr("class")){case"rs_close":e.delArea(t.target.parentNode.parentNode.id);return false;case"bg":return}switch(t.target.tagName){case"LABEL":return false;case"B":var i=t.target.parentNode.id;switch(e.$areaData[i].color){case"red":e.setAreaColor(i,"yellow");break;case"yellow":e.setAreaColor(i,"blue");break;case"blue":e.setAreaColor(i,"green");break;case"green":e.setAreaColor(i,"red");break}return false}if(t.data.inthis.$ghost.css("display")=="none"){var a,o;var s=mousePosition(t),r=getElCoordinate(this);a=s.x-r.left+this.parentNode.parentNode.scrollLeft-1;o=s.y-r.top+this.parentNode.parentNode.scrollTop-1;var n=["red","yellow","blue","green"];t.data.inthis.addArea(t.data.inthis.$id+"_area_"+t.data.inthis.$max,{name:"area_"+t.data.inthis.$max,left:a,top:o,color:n[t.data.inthis.$max%4],width:200,height:100});t.data.inthis.$max++;return false}})},setNodeRemarks:function(t){this.$tool.children("a").each(function(){this.title=t[$(this).attr("id").split("btn_")[1]]});this.$nodeRemark=t},switchToolBtn:function(t){this.$tool.children("#"+this.$id+"_btn_"+this.$nowType.split(" ")[0]).attr("class","GooFlow_tool_btn");if(this.$nowType=="group"){this.$workArea.prepend(this.$group);for(var e in this.$areaDom)this.$areaDom[e].addClass("lock").children("div:eq(1)").css("display","none")}this.$nowType=t;this.$tool.children("#"+this.$id+"_btn_"+t.split(" ")[0]).attr("class","GooFlow_tool_btndown");if(this.$nowType=="group"){this.blurItem();this.$workArea.append(this.$group);for(var e in this.$areaDom)this.$areaDom[e].removeClass("lock").children("div:eq(1)").css("display","")}if(this.$textArea.css("display")=="none")this.$textArea.removeData("id").val("").hide()},addNode:function(t,e){if(this.onItemAdd!=null&&!this.onItemAdd(t,"node",e))return;if(this.$undoStack&&this.$editable){this.pushOper("delNode",[t])}var i=e.mark?" item_mark":"";if(e.type.indexOf(" round")<0){if(!e.width||e.width<26)e.width=26;if(!e.height||e.height<24)e.height=24;if(!e.top||e.top<0)e.top=0;if(!e.left||e.left<0)e.left=0;var a=0;this.$nodeDom[t]=$("<div class='GooFlow_item item_round"+i+"' id='"+t+"' style='top:"+e.top+"px;left:"+e.left+"px'><table cellspacing='1' style='width:"+(e.width-2)+"px;height:"+(e.height-2)+"px;'><tr><td class='ico'><b class='ico_"+e.type+"'></b></td><td class='span'>"+e.name+"</td></tr></table><div style='display:none'><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>");if(e.type.indexOf(" mix")>-1)this.$nodeDom[t].addClass("item_mix")}else{e.width=24;e.height=24;this.$nodeDom[t]=$("<div class='GooFlow_item item_round"+i+"' id='"+t+"' style='top:"+e.top+"px;left:"+e.left+"px'><table cellspacing='0'><tr><td class='ico'><b class='ico_"+e.type+"'></b></td></tr></table><div  style='display:none'><div class='rs_close'></div></div><div class='span'>"+e.name+"</div></div>")}this.$workArea.append(this.$nodeDom[t]);this.$nodeData[t]=e;++this.$nodeCount;if(this.$editable){this.$nodeData[t].alt=true;if(this.$deletedItem[t])delete this.$deletedItem[t]}},initWorkForNode:function(){this.$workArea.delegate(".GooFlow_item","click",{inthis:this},function(t){t.data.inthis.focusItem(this.id,true);$(this).removeClass("item_mark")});this.$workArea.delegate(".ico","mousedown",{inthis:this},function(t){if(!t)t=window.event;if(t.button==2)return false;var i=t.data.inthis;if(i.$nowType=="direct")return;var e=$(this).parents(".GooFlow_item");var a=e.attr("id");i.focusItem(a,true);var o=1;var s=mousePosition(t),r=getElCoordinate(i.$workArea[0]);e.children("table").css("width","22px").clone().prependTo(i.$ghost);var n,l;n=s.x-r.left+i.$workArea[0].parentNode.scrollLeft;l=s.y-r.top+i.$workArea[0].parentNode.scrollTop;var h=n-i.$nodeData[a].left,d=l-i.$nodeData[a].top;var f=false;document.onmousemove=function(t){if(!t)t=window.event;var e=mousePosition(t);if(n==e.x-h&&l==e.y-d)return false;n=e.x-h;l=e.y-d;if(f&&i.$ghost.css("display")=="none"){i.$ghost.css({display:"block",width:i.$nodeData[a].width-2+"px",height:i.$nodeData[a].height-2+"px",top:i.$nodeData[a].top+r.top-i.$workArea[0].parentNode.scrollTop+o+"px",left:i.$nodeData[a].left+r.left-i.$workArea[0].parentNode.scrollLeft+o+"px",cursor:"move"})}if(n<r.left-i.$workArea[0].parentNode.scrollLeft)n=r.left-i.$workArea[0].parentNode.scrollLeft;else if(n+i.$workArea[0].parentNode.scrollLeft+i.$nodeData[a].width>r.left+i.$workArea.width())n=r.left+i.$workArea.width()-i.$workArea[0].parentNode.scrollLeft-i.$nodeData[a].width;if(l<r.top-i.$workArea[0].parentNode.scrollTop)l=r.top-i.$workArea[0].parentNode.scrollTop;else if(l+i.$workArea[0].parentNode.scrollTop+i.$nodeData[a].height>r.top+i.$workArea.height())l=r.top+i.$workArea.height()-i.$workArea[0].parentNode.scrollTop-i.$nodeData[a].height;i.$ghost.css({left:n+o+"px",top:l+o+"px"});f=true};document.onmouseup=function(t){if(f)i.moveNode(a,n+i.$workArea[0].parentNode.scrollLeft-r.left,l+i.$workArea[0].parentNode.scrollTop-r.top);i.$ghost.empty().hide();document.onmousemove=null;document.onmouseup=null}});if(!this.$editable)return;this.$workArea.delegate(".GooFlow_item","mouseenter",{inthis:this},function(t){if(t.data.inthis.$nowType!="direct")return;$(this).addClass("item_mark")});this.$workArea.delegate(".GooFlow_item","mouseleave",{inthis:this},function(t){if(t.data.inthis.$nowType!="direct")return;$(this).removeClass("item_mark")});this.$workArea.delegate(".GooFlow_item","mousedown",{inthis:this},function(t){if(t.button==2)return false;var e=t.data.inthis;if(e.$nowType!="direct")return;var i=mousePosition(t),a=getElCoordinate(e.$workArea[0]);var o,s;o=i.x-a.left+e.$workArea[0].parentNode.scrollLeft;s=i.y-a.top+e.$workArea[0].parentNode.scrollTop;e.$workArea.data("lineStart",{x:o,y:s,id:this.id}).css("cursor","crosshair");var r=GooFlow.prototype.drawLine("GooFlow_tmp_line",[o,s],[o,s],true,true);e.$draw.appendChild(r)});this.$workArea.delegate(".GooFlow_item","mouseup",{inthis:this},function(t){var e=t.data.inthis;if(e.$nowType!="direct")return;var i=e.$workArea.data("lineStart");if(i)e.addLine(e.$id+"_line_"+e.$max,{from:i.id,to:this.id,name:""});e.$max++});this.$workArea.delegate(".GooFlow_item > .span","dblclick",{inthis:this},function(t){var e=this.innerHTML;var i=t.data.inthis;var a=this.parentNode.id;var o=getElCoordinate(i.$workArea[0]);i.$textArea.val(e).css({display:"block",height:$(this).height(),width:100,left:o.left+i.$nodeData[a].left-i.$workArea[0].parentNode.scrollLeft-24,top:o.top+i.$nodeData[a].top-i.$workArea[0].parentNode.scrollTop+26}).data("id",i.$focus).focus();i.$workArea.parent().one("mousedown",function(t){if(t.button==2)return false;i.setName(i.$textArea.data("id"),i.$textArea.val(),"node");i.$textArea.val("").removeData("id").hide()})});this.$workArea.delegate(".ico + td","dblclick",{inthis:this},function(t){var e=this.innerHTML;var i=t.data.inthis;var a=$(this).parents(".GooFlow_item").attr("id");var o=getElCoordinate(i.$workArea[0]);i.$textArea.val(e).css({display:"block",width:$(this).width()+24,height:$(this).height(),left:o.left-10+i.$nodeData[a].left-i.$workArea[0].parentNode.scrollLeft,top:o.top+26+i.$nodeData[a].top-i.$workArea[0].parentNode.scrollTop}).data("id",i.$focus).focus();i.$workArea.parent().one("mousedown",function(t){if(t.button==2)return false;i.setName(i.$textArea.data("id"),i.$textArea.val(),"node");i.$textArea.val("").removeData("id").hide()})});this.$workArea.delegate(".rs_close","click",{inthis:this},function(t){if(!t)t=window.event;t.data.inthis.delNode(t.data.inthis.$focus);return false});this.$workArea.delegate(".GooFlow_area > div > div[class!=rs_close]","mousedown",{inthis:this},function(t){if(!t)t=window.event;if(t.button==2)return false;var i=$(this).css("cursor");if(i=="pointer"){return}var a=t.data.inthis;var o=a.$focus;a.switchToolBtn("cursor");t.cancelBubble=true;t.stopPropagation();var e=1;var s=mousePosition(t),r=getElCoordinate(a.$workArea[0]);a.$ghost.css({display:"block",width:a.$nodeData[o].width-2+"px",height:a.$nodeData[o].height-2+"px",top:a.$nodeData[o].top+r.top-a.$workArea[0].parentNode.scrollTop+e+"px",left:a.$nodeData[o].left+r.left-a.$workArea[0].parentNode.scrollLeft+e+"px",cursor:i});var n,l;n=s.x-r.left+a.$workArea[0].parentNode.scrollLeft;l=s.y-r.top+a.$workArea[0].parentNode.scrollTop;var h=a.$nodeData[o].left+a.$nodeData[o].width-n;var d=a.$nodeData[o].top+a.$nodeData[o].height-l;var f=false;a.$ghost.css("cursor",i);document.onmousemove=function(t){if(!t)t=window.event;var e=mousePosition(t);n=e.x-r.left+a.$workArea[0].parentNode.scrollLeft-a.$nodeData[o].left+h;l=e.y-r.top+a.$workArea[0].parentNode.scrollTop-a.$nodeData[o].top+d;if(n<26)n=26;if(l<24)l=24;f=true;switch(i){case"nw-resize":a.$ghost.css({width:n-2+"px",height:l-2+"px"});break;case"w-resize":a.$ghost.css({width:n-2+"px"});break;case"n-resize":a.$ghost.css({height:l-2+"px"});break}};document.onmouseup=function(t){a.$ghost.hide();if(!f)return;if(!t)t=window.event;a.resizeNode(o,a.$ghost.outerWidth(),a.$ghost.outerHeight());document.onmousemove=null;document.onmouseup=null}})},getItemInfo:function(t,e){switch(e){case"node":return this.$nodeData[t]||null;case"line":return this.$lineData[t]||null;case"area":return this.$areaData[t]||null}},blurItem:function(){if(this.$focus!=""){var t=$("#"+this.$focus);if(t.prop("tagName")=="DIV"){if(this.onItemBlur!=null&&!this.onItemBlur(id,"node"))return false;t.removeClass("item_focus").children("div:eq(0)").css("display","none")}else{if(this.onItemBlur!=null&&!this.onItemBlur(id,"line"))return false;if(!this.$lineData[this.$focus].marked){t[0].childNodes[1].setAttribute("stroke","#5068AE");t[0].childNodes[1].setAttribute("marker-end","url(#arrow1)")}this.$lineMove.hide().removeData("type").removeData("tid");if(this.$editable)this.$lineOper.hide().removeData("tid")}}this.$focus="";return true},focusItem:function(t,e){var i=$("#"+t);if(i.length==0)return;if(!this.blurItem())return;if(i.prop("tagName")=="DIV"){if(e&&this.onItemFocus!=null&&!this.onItemFocus(t,"node"))return;i.addClass("item_focus");if(this.$editable)i.children("div:eq(0)").css("display","block");this.$workArea.append(i)}else{if(this.onItemFocus!=null&&!this.onItemFocus(t,"line"))return;i[0].childNodes[1].setAttribute("stroke","#ff3300");i[0].childNodes[1].setAttribute("marker-end","url(#arrow2)");if(!this.$editable)return;var a,o,s,r;s=i.attr("from").split(",");r=i.attr("to").split(",");s[0]=parseInt(s[0],10);s[1]=parseInt(s[1],10);r[0]=parseInt(r[0],10);r[1]=parseInt(r[1],10);if(this.$lineData[t].type=="lr"){s[0]=this.$lineData[t].M;r[0]=s[0];this.$lineMove.css({width:"5px",height:(r[1]-s[1])*(r[1]>s[1]?1:-1)+"px",left:s[0]-3+"px",top:(r[1]>s[1]?s[1]:r[1])+1+"px",cursor:"e-resize",display:"block"}).data({type:"lr",tid:t})}else if(this.$lineData[t].type=="tb"){s[1]=this.$lineData[t].M;r[1]=s[1];this.$lineMove.css({width:(r[0]-s[0])*(r[0]>s[0]?1:-1)+"px",height:"5px",left:(r[0]>s[0]?s[0]:r[0])+1+"px",top:s[1]-3+"px",cursor:"s-resize",display:"block"}).data({type:"tb",tid:t})}a=(s[0]+r[0])/2-35;o=(s[1]+r[1])/2+6;this.$lineOper.css({display:"block",left:a+"px",top:o+"px"}).data("tid",t)}this.$focus=t;this.switchToolBtn("cursor")},moveNode:function(t,e,i){if(!this.$nodeData[t])return;if(this.onItemMove!=null&&!this.onItemMove(t,"node",e,i))return;if(this.$undoStack){var a=[t,this.$nodeData[t].left,this.$nodeData[t].top];this.pushOper("moveNode",a)}if(e<0)e=0;if(i<0)i=0;$("#"+t).css({left:e+"px",top:i+"px"});this.$nodeData[t].left=e;this.$nodeData[t].top=i;this.resetLines(t,this.$nodeData[t]);if(this.$editable){this.$nodeData[t].alt=true}},setName:function(t,e,i){var a;if(i=="node"){if(!this.$nodeData[t])return;if(this.$nodeData[t].name==e)return;if(this.onItemRename!=null&&!this.onItemRename(t,e,"node"))return;a=this.$nodeData[t].name;this.$nodeData[t].name=e;if(this.$nodeData[t].type.indexOf("round")>1){this.$nodeDom[t].children(".span").text(e)}else{this.$nodeDom[t].find("td:eq(1)").text(e);var o=0;var s=this.$nodeDom[t].outerWidth();var r=this.$nodeDom[t].outerHeight();this.$nodeDom[t].children("table").css({width:s-2+"px",height:r-2+"px"});this.$nodeData[t].width=s;this.$nodeData[t].height=r}if(this.$editable){this.$nodeData[t].alt=true}this.resetLines(t,this.$nodeData[t])}else if(i=="line"){if(!this.$lineData[t])return;if(this.$lineData[t].name==e)return;if(this.onItemRename!=null&&!this.onItemRename(t,e,"line"))return;a=this.$lineData[t].name;this.$lineData[t].name=e;this.$lineDom[t].childNodes[2].textContent=e;if(this.$editable){this.$lineData[t].alt=true}}else if(i=="area"){if(!this.$areaData[t])return;if(this.$areaData[t].name==e)return;if(this.onItemRename!=null&&!this.onItemRename(t,e,"area"))return;a=this.$areaData[t].name;this.$areaData[t].name=e;this.$areaDom[t].children("label").text(e);if(this.$editable){this.$areaData[t].alt=true}}if(this.$undoStack){var n=[t,a,i];this.pushOper("setName",n)}},resizeNode:function(t,e,i){if(!this.$nodeData[t])return;if(this.onItemResize!=null&&!this.onItemResize(t,"node",e,i))return;if(this.$nodeData[t].type=="start"||this.$nodeData[t].type=="end")return;if(this.$undoStack){var a=[t,this.$nodeData[t].width,this.$nodeData[t].height];this.pushOper("resizeNode",a)}var o=0;this.$nodeDom[t].children("table").css({width:e-2+"px",height:i-2+"px"});e=this.$nodeDom[t].outerWidth()-o;i=this.$nodeDom[t].outerHeight()-o;this.$nodeDom[t].children("table").css({width:e-2+"px",height:i-2+"px"});this.$nodeData[t].width=e;this.$nodeData[t].height=i;if(this.$editable){this.$nodeData[t].alt=true}this.resetLines(t,this.$nodeData[t])},delNode:function(t){if(!this.$nodeData[t])return;if(this.onItemDel!=null&&!this.onItemDel(t,"node"))return;for(var e in this.$lineData){if(this.$lineData[e].from==t||this.$lineData[e].to==t){this.delLine(e)}}if(this.$undoStack){var i=[t,this.$nodeData[t]];this.pushOper("addNode",i)}delete this.$nodeData[t];this.$nodeDom[t].remove();delete this.$nodeDom[t];--this.$nodeCount;if(this.$focus==t)this.$focus="";if(this.$editable){if(t.indexOf(this.$id+"_node_")<0)this.$deletedItem[t]="node"}},setTitle:function(t){this.$title=t;if(this.$head)this.$head.children("label").attr("title",t).text(t)},loadData:function(t){var e=this.$editable;this.$editable=false;if(t.title)this.setTitle(t.title);if(t.initNum)this.$max=t.initNum;for(var i in t.nodes)this.addNode(i,t.nodes[i]);for(var a in t.lines)this.addLine(a,t.lines[a]);for(var o in t.areas)this.addArea(o,t.areas[o]);this.$editable=e;this.$deletedItem={}},loadDataAjax:function(a){var e=this;$.ajax({type:a.type,url:a.url,dataType:"json",data:a.data,success:function(t){if(a.dataFilter)a.dataFilter(t,"json");e.loadData(t);if(a.success)a.success(t)},error:function(t,e,i){if(a.error)a.error(e,i)}})},exportData:function(){var t={title:this.$title,nodes:this.$nodeData,lines:this.$lineData,areas:this.$areaData,initNum:this.$max};for(var e in t.nodes){if(!t.nodes[e].marked){delete t.nodes[e]["marked"]}}for(var i in t.lines){if(!t.lines[i].marked){delete t.lines[i]["marked"]}}return t},exportAlter:function(){var t={nodes:{},lines:{},areas:{}};for(var e in this.$nodeData){if(this.$nodeData[e].alt){t.nodes[e]=this.$nodeData[e]}}for(var i in this.$lineData){if(this.$lineData[i].alt){t.lines[i]=this.$lineData[i]}}for(var a in this.$areaData){if(this.$areaData[a].alt){t.areas[a]=this.$areaData[a]}}t.deletedItem=this.$deletedItem;return t},transNewId:function(t,e,i){var a;switch(i){case"node":if(this.$nodeData[t]){a=this.$nodeData[t];delete this.$nodeData[t];this.$nodeData[e]=a}break;case"line":if(this.$lineData[t]){a=this.$lineData[t];delete this.$lineData[t];this.$lineData[e]=a}break;case"area":if(this.$areaData[t]){a=this.$areaData[t];delete this.$areaData[t];this.$areaData[e]=a}break}},clearData:function(){for(var t in this.$nodeData){this.delNode(t)}for(var t in this.$lineData){this.delLine(t)}for(var t in this.$areaData){this.delArea(t)}this.$deletedItem={}},destrory:function(){this.$bgDiv.empty();this.$lineData=null;this.$nodeData=null;this.$lineDom=null;this.$nodeDom=null;this.$areaDom=null;this.$areaData=null;this.$nodeCount=0;this.$areaCount=0;this.$areaCount=0;this.$deletedItem={}},drawLine:function(t,e,i,a,o){var s;s=document.createElementNS("http://www.w3.org/2000/svg","g");var r=document.createElementNS("http://www.w3.org/2000/svg","path");var n=document.createElementNS("http://www.w3.org/2000/svg","path");if(t!="")s.setAttribute("id",t);s.setAttribute("from",e[0]+","+e[1]);s.setAttribute("to",i[0]+","+i[1]);r.setAttribute("visibility","hidden");r.setAttribute("stroke-width",9);r.setAttribute("fill","none");r.setAttribute("stroke","white");r.setAttribute("d","M "+e[0]+" "+e[1]+" L "+i[0]+" "+i[1]);r.setAttribute("pointer-events","stroke");n.setAttribute("d","M "+e[0]+" "+e[1]+" L "+i[0]+" "+i[1]);n.setAttribute("stroke-width",1.4);n.setAttribute("stroke-linecap","round");n.setAttribute("fill","none");if(o)n.setAttribute("style","stroke-dasharray:6,5");if(a){n.setAttribute("stroke","#ff3300");n.setAttribute("marker-end","url(#arrow2)")}else{n.setAttribute("stroke","#5068AE");n.setAttribute("marker-end","url(#arrow1)")}s.appendChild(r);s.appendChild(n);s.style.cursor="crosshair";if(t!=""&&t!="GooFlow_tmp_line"){var l=document.createElementNS("http://www.w3.org/2000/svg","text");s.appendChild(l);var h=(i[0]+e[0])/2;var d=(i[1]+e[1])/2;l.setAttribute("text-anchor","middle");l.setAttribute("x",h);l.setAttribute("y",d);s.style.cursor="pointer";l.style.cursor="text"}return s},drawPoly:function(t,e,i,a,o,s){var r,n;r=document.createElementNS("http://www.w3.org/2000/svg","g");var l=document.createElementNS("http://www.w3.org/2000/svg","path");var h=document.createElementNS("http://www.w3.org/2000/svg","path");if(t!="")r.setAttribute("id",t);r.setAttribute("from",e[0]+","+e[1]);r.setAttribute("to",o[0]+","+o[1]);l.setAttribute("visibility","hidden");l.setAttribute("stroke-width",9);l.setAttribute("fill","none");l.setAttribute("stroke","white");n="M "+e[0]+" "+e[1];if(i[0]!=e[0]||i[1]!=e[1])n+=" L "+i[0]+" "+i[1];if(a[0]!=o[0]||a[1]!=o[1])n+=" L "+a[0]+" "+a[1];n+=" L "+o[0]+" "+o[1];l.setAttribute("d",n);l.setAttribute("pointer-events","stroke");h.setAttribute("d",n);h.setAttribute("stroke-width",1.4);h.setAttribute("stroke-linecap","round");h.setAttribute("fill","none");if(s){h.setAttribute("stroke","#ff3300");h.setAttribute("marker-end","url(#arrow2)")}else{h.setAttribute("stroke","#5068AE");h.setAttribute("marker-end","url(#arrow1)")}r.appendChild(l);r.appendChild(h);var d=document.createElementNS("http://www.w3.org/2000/svg","text");r.appendChild(d);var $=(a[0]+i[0])/2;var f=(a[1]+i[1])/2;d.setAttribute("text-anchor","middle");d.setAttribute("x",$);d.setAttribute("y",f);d.style.cursor="text";r.style.cursor="pointer";return r},calcStartEnd:function(t,e){var i,a,o,s;var r=t.left,n=t.left+t.width,l=e.left,h=e.left+e.width;if(r>=h){i=r;o=h}else if(n<=l){i=n;o=l}else if(r<=l&&n>=l&&n<=h){i=(n+l)/2;o=i}else if(r>=l&&n<=h){i=(r+n)/2;o=i}else if(l>=r&&h<=n){i=(l+h)/2;o=i}else if(r<=h&&n>=h){i=(r+h)/2;o=i}var d=t.top,$=t.top+t.height,f=e.top,p=e.top+e.height;if(d>=p){a=d;s=p}else if($<=f){a=$;s=f}else if(d<=f&&$>=f&&$<=p){a=($+f)/2;s=a}else if(d>=f&&$<=p){a=(d+$)/2;s=a}else if(f>=d&&p<=$){a=(f+p)/2;s=a}else if(d<=p&&$>=p){a=(d+p)/2;s=a}return{start:[i,a],end:[o,s]}},calcPolyPoints:function(t,e,i,a){var o={x:t.left+t.width/2,y:t.top+t.height/2};var s={x:e.left+e.width/2,y:e.top+e.height/2};var r=[],n=[],l=[],h=[];r=[o.x,o.y];h=[s.x,s.y];if(i=="lr"){n=[a,o.y];l=[a,s.y];if(n[0]>t.left&&n[0]<t.left+t.width){n[1]=o.y>s.y?t.top:t.top+t.height;r[0]=n[0];r[1]=n[1]}else{r[0]=n[0]<t.left?t.left:t.left+t.width}if(l[0]>e.left&&l[0]<e.left+e.width){l[1]=o.y>s.y?e.top+e.height:e.top;h[0]=l[0];h[1]=l[1]}else{h[0]=l[0]<e.left?e.left:e.left+e.width}}else if(i=="tb"){n=[o.x,a];l=[s.x,a];if(n[1]>t.top&&n[1]<t.top+t.height){n[0]=o.x>s.x?t.left:t.left+t.width;r[0]=n[0];r[1]=n[1]}else{r[1]=n[1]<t.top?t.top:t.top+t.height}if(l[1]>e.top&&l[1]<e.top+e.height){l[0]=o.x>s.x?e.left+e.width:e.left;h[0]=l[0];h[1]=l[1]}else{h[1]=l[1]<e.top?e.top:e.top+e.height}}return{start:r,m1:n,m2:l,end:h}},getMValue:function(t,e,i){if(i=="lr"){return(t.left+t.width/2+e.left+e.width/2)/2}else if(i=="tb"){return(t.top+t.height/2+e.top+e.height/2)/2}},addLine:function(t,e){if(this.onItemAdd!=null&&!this.onItemAdd(t,"line",e))return;if(this.$undoStack&&this.$editable){this.pushOper("delLine",[t])}var i=null,a=null;if(e.from==e.to)return;for(var o in this.$lineData){if(e.from==this.$lineData[o].from&&e.to==this.$lineData[o].to)return}var i=this.$nodeData[e.from],a=this.$nodeData[e.to];if(!i||!a)return;var s;if(e.type&&e.type!="sl")s=GooFlow.prototype.calcPolyPoints(i,a,e.type,e.M);else s=GooFlow.prototype.calcStartEnd(i,a);if(!s)return;this.$lineData[t]={};if(e.type){this.$lineData[t].type=e.type;this.$lineData[t].M=e.M}else this.$lineData[t].type="sl";this.$lineData[t].from=e.from;this.$lineData[t].to=e.to;this.$lineData[t].name=e.name;if(e.mark)this.$lineData[t].marked=e.mark;else this.$lineData[t].marked=false;if(this.$lineData[t].type=="sl")this.$lineDom[t]=GooFlow.prototype.drawLine(t,s.start,s.end,e.mark);else this.$lineDom[t]=GooFlow.prototype.drawPoly(t,s.start,s.m1,s.m2,s.end,e.mark);this.$draw.appendChild(this.$lineDom[t]);this.$lineDom[t].childNodes[1].innerHTML=e.name;if(this.$lineData[t].type!="sl"){var r=s.start[0]>s.end[0]?s.end[0]:s.start[0];if(r>s.m2[0])r=s.m2[0];if(r>s.m1[0])r=s.m1[0];this.$lineDom[t].childNodes[1].style.left=(s.m2[0]+s.m1[0])/2-r-this.$lineDom[t].childNodes[1].offsetWidth/2+4;r=s.start[1]>s.end[1]?s.end[1]:s.start[1];if(r>s.m2[1])r=s.m2[1];if(r>s.m1[1])r=s.m1[1];this.$lineDom[t].childNodes[1].style.top=(s.m2[1]+s.m1[1])/2-r-this.$lineDom[t].childNodes[1].offsetHeight/2}else this.$lineDom[t].childNodes[1].style.left=((s.end[0]-s.start[0])*(s.end[0]>s.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4;++this.$lineCount;if(this.$editable){this.$lineData[t].alt=true;if(this.$deletedItem[t])delete this.$deletedItem[t]}},resetLines:function(t,e){for(var i in this.$lineData){var a=null;var o;if(this.$lineData[i].from==t){a=this.$nodeData[this.$lineData[i].to]||null;if(a==null)continue;if(this.$lineData[i].type=="sl")o=GooFlow.prototype.calcStartEnd(e,a);else o=GooFlow.prototype.calcPolyPoints(e,a,this.$lineData[i].type,this.$lineData[i].M);if(!o)break}else if(this.$lineData[i].to==t){a=this.$nodeData[this.$lineData[i].from]||null;if(a==null)continue;if(this.$lineData[i].type=="sl")o=GooFlow.prototype.calcStartEnd(a,e);else o=GooFlow.prototype.calcPolyPoints(a,e,this.$lineData[i].type,this.$lineData[i].M);if(!o)break}if(a==null)continue;this.$draw.removeChild(this.$lineDom[i]);if(this.$lineData[i].type=="sl"){this.$lineDom[i]=GooFlow.prototype.drawLine(i,o.start,o.end,this.$lineData[i].marked)}else{this.$lineDom[i]=GooFlow.prototype.drawPoly(i,o.start,o.m1,o.m2,o.end,this.$lineData[i].marked)}this.$draw.appendChild(this.$lineDom[i]);this.$lineDom[i].childNodes[1].innerHTML=this.$lineData[i].name;if(this.$lineData[i].type!="sl"){var s=o.start[0]>o.end[0]?o.end[0]:o.start[0];if(s>o.m2[0])s=o.m2[0];if(s>o.m1[0])s=o.m1[0];this.$lineDom[i].childNodes[1].style.left=(o.m2[0]+o.m1[0])/2-s-this.$lineDom[i].childNodes[1].offsetWidth/2+4;s=o.start[1]>o.end[1]?o.end[1]:o.start[1];if(s>o.m2[1])s=o.m2[1];if(s>o.m1[1])s=o.m1[1];this.$lineDom[i].childNodes[1].style.top=(o.m2[1]+o.m1[1])/2-s-this.$lineDom[i].childNodes[1].offsetHeight/2-4}else this.$lineDom[i].childNodes[1].style.left=((o.end[0]-o.start[0])*(o.end[0]>o.start[0]?1:-1)-this.$lineDom[i].childNodes[1].offsetWidth)/2+4}},setLineType:function(t,e){if(!e||e==null||e==""||e==this.$lineData[t].type)return false;if(this.onLineSetType!=null&&!this.onLineSetType(t,e))return;if(this.$undoStack){var i=[t,this.$lineData[t].type];this.pushOper("setLineType",i);if(this.$lineData[t].type!="sl"){var a=[t,this.$lineData[t].M];this.pushOper("setLineM",a)}}var o=this.$lineData[t].from;var s=this.$lineData[t].to;this.$lineData[t].type=e;var r;if(e!="sl"){var r=GooFlow.prototype.calcPolyPoints(this.$nodeData[o],this.$nodeData[s],this.$lineData[t].type,this.$lineData[t].M);this.setLineM(t,this.getMValue(this.$nodeData[o],this.$nodeData[s],e),true)}else{delete this.$lineData[t].M;this.$lineMove.hide().removeData("type").removeData("tid");r=GooFlow.prototype.calcStartEnd(this.$nodeData[o],this.$nodeData[s]);if(!r)return;this.$draw.removeChild(this.$lineDom[t]);this.$lineDom[t]=GooFlow.prototype.drawLine(t,r.start,r.end,this.$lineData[t].marked||this.$focus==t);this.$draw.appendChild(this.$lineDom[t]);this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name;this.$lineDom[t].childNodes[1].style.left=((r.end[0]-r.start[0])*(r.end[0]>r.start[0]?1:-1)-this.$lineDom[t].childNodes[1].offsetWidth)/2+4}if(this.$focus==t){this.focusItem(t)}if(this.$editable){this.$lineData[t].alt=true}},setLineM:function(t,e,i){if(!this.$lineData[t]||e<0||!this.$lineData[t].type||this.$lineData[t].type=="sl")return false;if(this.onLineMove!=null&&!this.onLineMove(t,e))return false;if(this.$undoStack&&!i){var a=[t,this.$lineData[t].M];this.pushOper("setLineM",a)}var o=this.$lineData[t].from;var s=this.$lineData[t].to;this.$lineData[t].M=e;var r=GooFlow.prototype.calcPolyPoints(this.$nodeData[o],this.$nodeData[s],this.$lineData[t].type,this.$lineData[t].M);this.$draw.removeChild(this.$lineDom[t]);this.$lineDom[t]=GooFlow.prototype.drawPoly(t,r.start,r.m1,r.m2,r.end,this.$lineData[t].marked||this.$focus==t);this.$draw.appendChild(this.$lineDom[t]);this.$lineDom[t].childNodes[1].innerHTML=this.$lineData[t].name;var n=r.start[0]>r.end[0]?r.end[0]:r.start[0];if(n>r.m2[0])n=r.m2[0];if(n>r.m1[0])n=r.m1[0];this.$lineDom[t].childNodes[1].style.left=(r.m2[0]+r.m1[0])/2-n-this.$lineDom[t].childNodes[1].offsetWidth/2+4;n=r.start[1]>r.end[1]?r.end[1]:r.start[1];if(n>r.m2[1])n=r.m2[1];if(n>r.m1[1])n=r.m1[1];this.$lineDom[t].childNodes[1].style.top=(r.m2[1]+r.m1[1])/2-n-this.$lineDom[t].childNodes[1].offsetHeight/2-4;if(this.$editable){this.$lineData[t].alt=true}},delLine:function(t){if(!this.$lineData[t])return;if(this.onItemDel!=null&&!this.onItemDel(t,"node"))return;if(this.$undoStack){var e=[t,this.$lineData[t]];this.pushOper("addLine",e)}this.$draw.removeChild(this.$lineDom[t]);delete this.$lineData[t];delete this.$lineDom[t];if(this.$focus==t)this.$focus="";--this.$lineCount;if(this.$editable){if(t.indexOf(this.$id+"_line_")<0)this.$deletedItem[t]="line"}this.$lineOper.hide()},markItem:function(t,e,i){if(e=="node"){if(!this.$nodeData[t])return;if(this.onItemMark!=null&&!this.onItemMark(t,"node",i))return;this.$nodeData[t].marked=i||false;if(i)this.$nodeDom[t].addClass("item_mark");else this.$nodeDom[t].removeClass("item_mark")}else if(e=="line"){if(!this.$lineData[t])return;if(this.onItemMark!=null&&!this.onItemMark(t,"line",i))return;this.$lineData[t].marked=i||false;if(i){this.$nodeDom[t].childNodes[1].setAttribute("stroke","#ff3300");this.$nodeDom[t].childNodes[1].setAttribute("marker-end","url(#arrow2)")}else{this.$nodeDom[t].childNodes[1].setAttribute("stroke","#5068AE");this.$nodeDom[t].childNodes[1].setAttribute("marker-end","url(#arrow1)")}}if(this.$undoStatck){var a=[t,e,!i];this.pushOper("markItem",a)}},moveArea:function(t,e,i){if(!this.$areaData[t])return;if(this.onItemMove!=null&&!this.onItemMove(t,"area",e,i))return;if(this.$undoStack){var a=[t,this.$areaData[t].left,this.$areaData[t].top];this.pushOper("moveNode",a)}if(e<0)e=0;if(i<0)i=0;$("#"+t).css({left:e+"px",top:i+"px"});this.$areaData[t].left=e;this.$areaData[t].top=i;if(this.$editable){this.$areaData[t].alt=true}},delArea:function(t){if(!this.$areaData[t])return;if(this.$undoStack){var e=[t,this.$areaData[t]];this.pushOper("addArea",e)}if(this.onItemDel!=null&&!this.onItemDel(t,"node"))return;delete this.$areaData[t];this.$areaDom[t].remove();delete this.$areaDom[t];--this.$areaCount;if(this.$editable){if(t.indexOf(this.$id+"_area_")<0)this.$deletedItem[t]="area"}},setAreaColor:function(t,e){if(!this.$areaData[t])return;if(this.$undoStack){var i=[t,this.$areaData[t].color];this.pushOper("setAreaColor",i)}if(e=="red"||e=="yellow"||e=="blue"||e=="green"){this.$areaDom[t].removeClass("area_"+this.$areaData[t].color).addClass("area_"+e);this.$areaData[t].color=e}if(this.$editable){this.$areaData[t].alt=true}},resizeArea:function(t,e,i){if(!this.$areaData[t])return;if(this.onItemResize!=null&&!this.onItemResize(t,"area",e,i))return;if(this.$undoStack){var a=[t,this.$areaData[t].width,this.$areaData[t].height];this.pushOper("resizeArea",a)}var o=0;this.$areaDom[t].children(".bg").css({width:e-2+"px",height:i-2+"px"});e=this.$areaDom[t].outerWidth();i=this.$areaDom[t].outerHeight();this.$areaDom[t].children("bg").css({width:e-2+"px",height:i-2+"px"});this.$areaData[t].width=e;this.$areaData[t].height=i;if(this.$editable){this.$areaData[t].alt=true}},addArea:function(t,e){if(this.onItemAdd!=null&&!this.onItemAdd(t,"area",e))return;if(this.$undoStack&&this.$editable){this.pushOper("delArea",[t])}this.$areaDom[t]=$("<div id='"+t+"' class='GooFlow_area area_"+e.color+"' style='top:"+e.top+"px;left:"+e.left+"px'><div class='bg' style='width:"+(e.width-2)+"px;height:"+(e.height-2)+"px'></div>"+"<label>"+e.name+"</label><b></b><div><div class='rs_bottom'></div><div class='rs_right'></div><div class='rs_rb'></div><div class='rs_close'></div></div></div>");this.$areaData[t]=e;this.$group.append(this.$areaDom[t]);if(this.$nowType!="group")this.$areaDom[t].children("div:eq(1)").css("display","none");++this.$areaCount;if(this.$editable){this.$areaData[t].alt=true;if(this.$deletedItem[t])delete this.$deletedItem[t]}},reinitSize:function(t,e){var i=(t||800)-2;var a=(e||500)-2;this.$bgDiv.css({height:a+"px",width:i+"px"});var o=0,s=10;if(this.$head!=null){o=24;s=7}if(this.$tool!=null){this.$tool.css({height:a-o-s+"px"})}i-=39;a=a-o-(this.$head!=null?5:8);this.$workArea.parent().css({height:a+"px",width:i+"px"});this.$workArea.css({height:a*3+"px",width:i*3+"px"});this.$draw.coordsize=i*3+","+a*3;this.$draw.style.width=i*3+"px";this.$draw.style.height=+a*3+"px";if(this.$group==null){this.$group.css({height:a*3+"px",width:i*3+"px"})}}};jQuery.extend({createGooFlow:function(t,e){return new GooFlow(t,e)}});