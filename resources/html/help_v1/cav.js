CAV={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"};CAV.Array=typeof Float32Array==="function"?Float32Array:Array;CAV.Utils={isNumber:function(t){return!isNaN(parseFloat(t))&&isFinite(t)}};(function(){for(var s=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];if(!window.requestAnimationFrame)window.requestAnimationFrame=function(t){var i=(new Date).getTime(),e=Math.max(0,16-(i-s)),n=window.setTimeout(function(){t(i+e)},e);s=i+e;return n};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(t){clearTimeout(t)}})();Math.PIM2=Math.PI*2;Math.PID2=Math.PI/2;Math.randomInRange=function(t,i){return t+(i-t)*Math.random()};Math.clamp=function(t,i,e){t=Math.max(t,i);return t=Math.min(t,e)};CAV.Vector3={create:function(t,i,e){var n=new CAV.Array(3);this.set(n,t,i,e);return n},clone:function(t){var i=this.create();this.copy(i,t);return i},set:function(t,i,e,n){t[0]=i||0;t[1]=e||0;t[2]=n||0;return this},setX:function(t,i){t[0]=i||0;return this},setY:function(t,i){t[1]=i||0;return this},setZ:function(t,i){t[2]=i||0;return this},copy:function(t,i){t[0]=i[0];t[1]=i[1];t[2]=i[2];return this},add:function(t,i){t[0]+=i[0];t[1]+=i[1];t[2]+=i[2];return this},addVectors:function(t,i,e){t[0]=i[0]+e[0];t[1]=i[1]+e[1];t[2]=i[2]+e[2];return this},addScalar:function(t,i){t[0]+=i;t[1]+=i;t[2]+=i;return this},subtract:function(t,i){t[0]-=i[0];t[1]-=i[1];t[2]-=i[2];return this},subtractVectors:function(t,i,e){t[0]=i[0]-e[0];t[1]=i[1]-e[1];t[2]=i[2]-e[2];return this},subtractScalar:function(t,i){t[0]-=i;t[1]-=i;t[2]-=i;return this},multiply:function(t,i){t[0]*=i[0];t[1]*=i[1];t[2]*=i[2];return this},multiplyVectors:function(t,i,e){t[0]=i[0]*e[0];t[1]=i[1]*e[1];t[2]=i[2]*e[2];return this},multiplyScalar:function(t,i){t[0]*=i;t[1]*=i;t[2]*=i;return this},divide:function(t,i){t[0]/=i[0];t[1]/=i[1];t[2]/=i[2];return this},divideVectors:function(t,i,e){t[0]=i[0]/e[0];t[1]=i[1]/e[1];t[2]=i[2]/e[2];return this},divideScalar:function(t,i){i!==0?(t[0]/=i,t[1]/=i,t[2]/=i):(t[0]=0,t[1]=0,t[2]=0);return this},cross:function(t,i){var e=t[0],n=t[1],s=t[2];t[0]=n*i[2]-s*i[1];t[1]=s*i[0]-e*i[2];t[2]=e*i[1]-n*i[0];return this},crossVectors:function(t,i,e){t[0]=i[1]*e[2]-i[2]*e[1];t[1]=i[2]*e[0]-i[0]*e[2];t[2]=i[0]*e[1]-i[1]*e[0];return this},min:function(t,i){t[0]<i&&(t[0]=i);t[1]<i&&(t[1]=i);t[2]<i&&(t[2]=i);return this},max:function(t,i){t[0]>i&&(t[0]=i);t[1]>i&&(t[1]=i);t[2]>i&&(t[2]=i);return this},clamp:function(t,i,e){this.min(t,i);this.max(t,e);return this},limit:function(t,i,e){var n=this.length(t);i!==null&&n<i?this.setLength(t,i):e!==null&&n>e&&this.setLength(t,e);return this},dot:function(t,i){return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]},normalise:function(t){return this.divideScalar(t,this.length(t))},negate:function(t){return this.multiplyScalar(t,-1)},distanceSquared:function(t,i){var e=t[0]-i[0],n=t[1]-i[1],s=t[2]-i[2];return e*e+n*n+s*s},distance:function(t,i){return Math.sqrt(this.distanceSquared(t,i))},lengthSquared:function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},length:function(t){return Math.sqrt(this.lengthSquared(t))},setLength:function(t,i){var e=this.length(t);e!==0&&i!==e&&this.multiplyScalar(t,i/e);return this}};CAV.Vector4={create:function(t,i,e){var n=new CAV.Array(4);this.set(n,t,i,e);return n},set:function(t,i,e,n,s){t[0]=i||0;t[1]=e||0;t[2]=n||0;t[3]=s||0;return this},setX:function(t,i){t[0]=i||0;return this},setY:function(t,i){t[1]=i||0;return this},setZ:function(t,i){t[2]=i||0;return this},setW:function(t,i){t[3]=i||0;return this},add:function(t,i){t[0]+=i[0];t[1]+=i[1];t[2]+=i[2];t[3]+=i[3];return this},multiplyVectors:function(t,i,e){t[0]=i[0]*e[0];t[1]=i[1]*e[1];t[2]=i[2]*e[2];t[3]=i[3]*e[3];return this},multiplyScalar:function(t,i){t[0]*=i;t[1]*=i;t[2]*=i;t[3]*=i;return this},min:function(t,i){t[0]<i&&(t[0]=i);t[1]<i&&(t[1]=i);t[2]<i&&(t[2]=i);t[3]<i&&(t[3]=i);return this},max:function(t,i){t[0]>i&&(t[0]=i);t[1]>i&&(t[1]=i);t[2]>i&&(t[2]=i);t[3]>i&&(t[3]=i);return this},clamp:function(t,i,e){this.min(t,i);this.max(t,e);return this}};CAV.Color=function(t,i){this.rgba=CAV.Vector4.create();this.hex=t||"#000000";this.opacity=CAV.Utils.isNumber(i)?i:1;this.set(this.hex,this.opacity)};CAV.Color.prototype={set:function(t,i){var t=t.replace("#",""),e=t.length/3;this.rgba[0]=parseInt(t.substring(e*0,e*1),16)/255;this.rgba[1]=parseInt(t.substring(e*1,e*2),16)/255;this.rgba[2]=parseInt(t.substring(e*2,e*3),16)/255;this.rgba[3]=CAV.Utils.isNumber(i)?i:this.rgba[3];return this},hexify:function(t){t=Math.ceil(t*255).toString(16);t.length===1&&(t="0"+t);return t},format:function(){var t=this.hexify(this.rgba[0]),i=this.hexify(this.rgba[1]),e=this.hexify(this.rgba[2]);return this.hex="#"+t+i+e}};CAV.Object=function(){this.position=CAV.Vector3.create()};CAV.Object.prototype={setPosition:function(t,i,e){CAV.Vector3.set(this.position,t,i,e);return this}};CAV.Light=function(t,i){CAV.Object.call(this);this.ambient=new CAV.Color(t||"#FFFFFF");this.diffuse=new CAV.Color(i||"#FFFFFF");this.ray=CAV.Vector3.create()};CAV.Light.prototype=Object.create(CAV.Object.prototype);CAV.Vertex=function(t,i,e){this.position=CAV.Vector3.create(t,i,e)};CAV.Vertex.prototype={setPosition:function(t,i,e){CAV.Vector3.set(this.position,t,i,e);return this}};CAV.Triangle=function(t,i,e){this.a=t||new CAV.Vertex;this.b=i||new CAV.Vertex;this.c=e||new CAV.Vertex;this.vertices=[this.a,this.b,this.c];this.u=CAV.Vector3.create();this.v=CAV.Vector3.create();this.centroid=CAV.Vector3.create();this.normal=CAV.Vector3.create();this.color=new CAV.Color;this.polygon=document.createElementNS(CAV.SVGNS,"polygon");this.polygon.setAttributeNS(null,"stroke-linejoin","round");this.polygon.setAttributeNS(null,"stroke-miterlimit","1");this.polygon.setAttributeNS(null,"stroke-width","1");this.computeCentroid();this.computeNormal()};CAV.Triangle.prototype={computeCentroid:function(){this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0];this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1];this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2];CAV.Vector3.divideScalar(this.centroid,3);return this},computeNormal:function(){CAV.Vector3.subtractVectors(this.u,this.b.position,this.a.position);CAV.Vector3.subtractVectors(this.v,this.c.position,this.a.position);CAV.Vector3.crossVectors(this.normal,this.u,this.v);CAV.Vector3.normalise(this.normal);return this}};CAV.Geometry=function(){this.vertices=[];this.triangles=[];this.dirty=false};CAV.Geometry.prototype={update:function(){if(this.dirty){var t,i;for(t=this.triangles.length-1;t>=0;t--)i=this.triangles[t],i.computeCentroid(),i.computeNormal();this.dirty=false}return this}};CAV.Plane=function(t,i,e,n){CAV.Geometry.call(this);this.width=t||100;this.height=i||100;this.segments=e||4;this.slices=n||4;this.segmentWidth=this.width/this.segments;this.sliceHeight=this.height/this.slices;var s,r,o,e=[];s=this.width*-.5;r=this.height*.5;for(t=0;t<=this.segments;t++){e.push([]);for(i=0;i<=this.slices;i++)n=new CAV.Vertex(s+t*this.segmentWidth,r-i*this.sliceHeight),e[t].push(n),this.vertices.push(n)}for(t=0;t<this.segments;t++)for(i=0;i<this.slices;i++)n=e[t+0][i+0],s=e[t+0][i+1],r=e[t+1][i+0],o=e[t+1][i+1],t0=new CAV.Triangle(n,s,r),t1=new CAV.Triangle(r,s,o),this.triangles.push(t0,t1)};CAV.Plane.prototype=Object.create(CAV.Geometry.prototype);CAV.Material=function(t,i){this.ambient=new CAV.Color(t||"#444444");this.diffuse=new CAV.Color(i||"#FFFFFF");this.slave=new CAV.Color};CAV.Mesh=function(t,i){CAV.Object.call(this);this.geometry=t||new CAV.Geometry;this.material=i||new CAV.Material;this.side=CAV.FRONT;this.visible=true};CAV.Mesh.prototype=Object.create(CAV.Object.prototype);CAV.Mesh.prototype.update=function(t,i){var e,n,s,r,o;this.geometry.update();if(i)for(e=this.geometry.triangles.length-1;e>=0;e--){n=this.geometry.triangles[e];CAV.Vector4.set(n.color.rgba);for(s=t.length-1;s>=0;s--)r=t[s],CAV.Vector3.subtractVectors(r.ray,r.position,n.centroid),CAV.Vector3.normalise(r.ray),o=CAV.Vector3.dot(n.normal,r.ray),this.side===CAV.FRONT?o=Math.max(o,0):this.side===CAV.BACK?o=Math.abs(Math.min(o,0)):this.side===CAV.DOUBLE&&(o=Math.max(Math.abs(o),0)),CAV.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,r.ambient.rgba),CAV.Vector4.add(n.color.rgba,this.material.slave.rgba),CAV.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,r.diffuse.rgba),CAV.Vector4.multiplyScalar(this.material.slave.rgba,o),CAV.Vector4.add(n.color.rgba,this.material.slave.rgba);CAV.Vector4.clamp(n.color.rgba,0,1)}return this};CAV.Scene=function(){this.meshes=[];this.lights=[]};CAV.Scene.prototype={add:function(t){t instanceof CAV.Mesh&&!~this.meshes.indexOf(t)?this.meshes.push(t):t instanceof CAV.Light&&!~this.lights.indexOf(t)&&this.lights.push(t);return this},remove:function(t){t instanceof CAV.Mesh&&~this.meshes.indexOf(t)?this.meshes.splice(this.meshes.indexOf(t),1):t instanceof CAV.Light&&~this.lights.indexOf(t)&&this.lights.splice(this.lights.indexOf(t),1);return this}};CAV.Renderer=function(){this.halfHeight=this.halfWidth=this.height=this.width=0};CAV.Renderer.prototype={setSize:function(t,i){if(!(this.width===t&&this.height===i))return this.width=t,this.height=i,this.halfWidth=this.width*.5,this.halfHeight=this.height*.5,this},clear:function(){return this},render:function(){return this}};CAV.CanvasRenderer=function(){CAV.Renderer.call(this);this.element=document.createElement("canvas");this.element.style.display="block";this.context=this.element.getContext("2d");this.setSize(this.element.width,this.element.height)};CAV.CanvasRenderer.prototype=Object.create(CAV.Renderer.prototype);CAV.CanvasRenderer.prototype.setSize=function(t,i){CAV.Renderer.prototype.setSize.call(this,t,i);this.element.width=t;this.element.height=i;this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight);return this};CAV.CanvasRenderer.prototype.clear=function(){CAV.Renderer.prototype.clear.call(this);this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height);return this};CAV.CanvasRenderer.prototype.render=function(t){CAV.Renderer.prototype.render.call(this,t);var i,e,n,s,r;this.clear();this.context.lineJoin="round";this.context.lineWidth=1;for(i=t.meshes.length-1;i>=0;i--)if(e=t.meshes[i],e.visible){e.update(t.lights,true);for(n=e.geometry.triangles.length-1;n>=0;n--)s=e.geometry.triangles[n],r=s.color.format(),this.context.beginPath(),this.context.moveTo(s.a.position[0],s.a.position[1]),this.context.lineTo(s.b.position[0],s.b.position[1]),this.context.lineTo(s.c.position[0],s.c.position[1]),this.context.closePath(),this.context.strokeStyle=r,this.context.fillStyle=r,this.context.stroke(),this.context.fill()}return this};